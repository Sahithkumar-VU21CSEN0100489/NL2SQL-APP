<!DOCTYPE html>
<html>
<head>
    <title>NL2SQL Web App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .main-card { max-width: 900px; margin: 40px auto; box-shadow: 0 2px 16px rgba(0,0,0,0.07); border-radius: 16px; }
        .table-responsive { max-height: 400px; overflow: auto; }
        .insight-box { background: #f6f6f6; border-left: 5px solid #0d6efd; padding: 18px; border-radius: 8px; font-size: 1.08em; }
        .error-box { background: #fff0f0; border-left: 5px solid #dc3545; padding: 18px; border-radius: 8px; color: #dc3545; font-weight: 500; }
        .chart-controls label { margin-right: 8px; }
        .chart-controls select, .chart-controls input[type=checkbox] { margin-right: 16px; }
        .form-label { font-weight: 500; }
        .form-section { margin-bottom: 32px; }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 12px; }
        .ai-badge { font-size: 1.2em; margin-left: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card bg-white p-4">
            <h2 class="mb-4 text-center">NL2SQL Web Application</h2>
            <form method="post" class="row g-3 align-items-center form-section">
                <div class="col-12 col-md-9">
                    <label class="form-label">Question:</label>
                    <input type="text" name="question" class="form-control" required value="{{ request.form.get('question', '') }}">
                </div>
                <div class="col-12 col-md-3 d-grid">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </form>
            {% if answer %}
                <div class="form-section">
                    <div class="section-title">Answer Table</div>
                    <div class="table-responsive">
                        <table id="result-table" class="table table-bordered table-hover align-middle mb-0">
                            <tr class="table-primary">
                                {% for col in answer[0] %}
                                    <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                            {% for row in answer[1:] %}
                                <tr>
                                {% for cell in row %}
                                    <td>{{ cell }}</td>
                                {% endfor %}
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
                <div class="form-section row g-4 align-items-start">
                    <div class="col-lg-7">
                        <div id="chart-controls" class="chart-controls mb-3" style="display:none;">
                            <label for="x-col" class="me-1">X (Labels):</label>
                            <select id="x-col" class="form-select form-select-sm d-inline-block w-auto me-2"></select>
                            <label for="y-col" class="me-1">Y (Values):</label>
                            <select id="y-col" class="form-select form-select-sm d-inline-block w-auto me-2"></select>
                            <div class="form-check form-check-inline align-middle me-2">
                                <input type="checkbox" id="multi-series" class="form-check-input" onchange="updateChartControls()">
                                <label class="form-check-label" for="multi-series">Plot all numeric columns</label>
                            </div>
                            <div class="btn-group ms-2 align-middle" role="group" aria-label="Chart type">
                                <button type="button" class="btn btn-outline-primary" id="btn-bar" data-chart="bar" onclick="selectChartType('bar')">Bar Graph</button>
                                <button type="button" class="btn btn-outline-success" id="btn-pie" data-chart="pie" onclick="selectChartType('pie')">Pie Chart</button>
                                <button type="button" class="btn btn-outline-info" id="btn-line" data-chart="line" onclick="selectChartType('line')">Line Chart</button>
                            </div>
                        </div>
                        <div class="bg-light rounded shadow-sm p-3" style="width: 100%; min-height: 420px;">
                            <canvas id="resultChart"></canvas>
                        </div>
                    </div>
                </div>
                {% if ai_insight %}
                    <div class="form-section">
                        <div class="section-title">AI Insight <span class="ai-badge" title="AI-generated">&#129302;</span></div>
                        <div class="insight-box">{{ ai_insight }}</div>
                    </div>
                {% endif %}
            {% endif %}
            {% if sql_query %}
                {# SQL query hidden as per user request #}
            {% endif %}
            {% if error %}
                <div class="form-section">
                    <div class="error-box">Error: {{ error }}</div>
                </div>
            {% endif %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Existing JS logic for chart/table highlighting and controls remains unchanged -->
    {% if answer %}
    <script>
    let chartInstance = null;
    let currentChartType = null;
    function selectChartType(type) {
        currentChartType = type;
        showChart(type);
        // Remove all btn-* and btn-outline-* classes from all buttons
        const btnBar = document.getElementById('btn-bar');
        const btnPie = document.getElementById('btn-pie');
        const btnLine = document.getElementById('btn-line');
        btnBar.classList.remove('active', 'btn-primary', 'btn-outline-primary');
        btnPie.classList.remove('active', 'btn-success', 'btn-outline-success');
        btnLine.classList.remove('active', 'btn-info', 'btn-outline-info');
        // Add filled class to selected, outline to others
        if(type === 'bar') {
            btnBar.classList.add('btn-primary', 'active');
            btnPie.classList.add('btn-outline-success');
            btnLine.classList.add('btn-outline-info');
        } else if(type === 'pie') {
            btnBar.classList.add('btn-outline-primary');
            btnPie.classList.add('btn-success', 'active');
            btnLine.classList.add('btn-outline-info');
        } else if(type === 'line') {
            btnBar.classList.add('btn-outline-primary');
            btnPie.classList.add('btn-outline-success');
            btnLine.classList.add('btn-info', 'active');
        }
    }
    {% if ai_highlight %}
    window.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('result-table');
        if (table) {
            for (let i = 1; i < table.rows.length; i++) {
                for (let j = 0; j < table.rows[i].cells.length; j++) {
                    if (table.rows[i].cells[j].innerText.trim() === "{{ ai_highlight }}") {
                        table.rows[i].cells[j].style.background = '#ffe066';
                        table.rows[i].cells[j].style.fontWeight = 'bold';
                    }
                }
            }
        }
    });
    {% endif %}
    function isNumericColumn(colIdx) {
        const table = document.getElementById('result-table');
        for (let i = 1; i < table.rows.length; i++) {
            if (table.rows[i].cells[colIdx]) {
                const val = table.rows[i].cells[colIdx].innerText;
                if (val.trim() !== '' && isNaN(Number(val))) return false;
            }
        }
        return true;
    }
    function populateDropdowns() {
        const table = document.getElementById('result-table');
        const headerCells = table.rows[0].cells;
        const xCol = document.getElementById('x-col');
        const yCol = document.getElementById('y-col');
        xCol.innerHTML = '';
        yCol.innerHTML = '';
        for (let i = 0; i < headerCells.length; i++) {
            const optionX = document.createElement('option');
            optionX.value = i;
            optionX.text = headerCells[i].innerText;
            xCol.appendChild(optionX);
            const optionY = document.createElement('option');
            optionY.value = i;
            optionY.text = headerCells[i].innerText;
            yCol.appendChild(optionY);
        }
        // Default: first column for X, first numeric column for Y
        xCol.selectedIndex = 0;
        for (let i = 1; i < headerCells.length; i++) {
            if (isNumericColumn(i)) {
                yCol.selectedIndex = i;
                break;
            }
        }
    }
    function getTableData(xIdx, yIdx, multiSeries) {
        const table = document.getElementById('result-table');
        const labels = [];
        const data = [];
        if (!multiSeries) {
            for (let i = 1; i < table.rows.length; i++) {
                labels.push(table.rows[i].cells[xIdx].innerText);
                data.push(Number(table.rows[i].cells[yIdx].innerText) || 0);
            }
            return { labels, datasets: [{ label: table.rows[0].cells[yIdx].innerText, data }] };
        } else {
            // Multi-series: all numeric columns except X
            for (let i = 1; i < table.rows.length; i++) {
                labels.push(table.rows[i].cells[xIdx].innerText);
            }
            const datasets = [];
            const tableHeader = table.rows[0];
            for (let col = 0; col < tableHeader.cells.length; col++) {
                if (col == xIdx) continue;
                if (isNumericColumn(col)) {
                    const seriesData = [];
                    for (let i = 1; i < table.rows.length; i++) {
                        seriesData.push(Number(table.rows[i].cells[col].innerText) || 0);
                    }
                    datasets.push({
                        label: tableHeader.cells[col].innerText,
                        data: seriesData,
                        borderWidth: 2,
                        fill: false
                    });
                }
            }
            return { labels, datasets };
        }
    }
    function showChart(type) {
        const xIdx = document.getElementById('x-col').value;
        const yIdx = document.getElementById('y-col').value;
        const multiSeries = document.getElementById('multi-series').checked;
        const ctx = document.getElementById('resultChart').getContext('2d');
        const { labels, datasets } = getTableData(xIdx, yIdx, multiSeries);
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: datasets.map((ds, i) => {
                    let backgroundColor, borderColor;
                    const paletteBg = [
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ];
                    const paletteBorder = [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ];
                    if (type === 'pie' || (type !== 'pie' && datasets.length === 1)) {
                        backgroundColor = labels.map((_, j) => paletteBg[j % paletteBg.length]);
                        borderColor = labels.map((_, j) => paletteBorder[j % paletteBorder.length]);
                    } else {
                        backgroundColor = paletteBg[i % paletteBg.length];
                        borderColor = paletteBorder[i % paletteBorder.length];
                    }
                    return Object.assign({}, ds, { backgroundColor, borderColor });
                })
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: type !== 'bar' || multiSeries }
                },
                scales: type === 'bar' || type === 'line' ? {
                    y: { beginAtZero: true }
                } : {}
            }
        });
    }
    function updateChartControls() {
        const table = document.getElementById('result-table');
        if (table && table.rows[0].cells.length >= 2) {
            populateDropdowns();
            let hasNumeric = false;
            for (let i = 1; i < table.rows[0].cells.length; i++) {
                if (isNumericColumn(i)) { hasNumeric = true; break; }
            }
            document.getElementById('chart-controls').style.display = hasNumeric ? '' : 'none';
        } else {
            document.getElementById('chart-controls').style.display = 'none';
        }
    }
    window.onload = updateChartControls;
    </script>
    {% if ai_x or ai_y or ai_chart %}
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('result-table');
        if (table) {
            const headerCells = table.rows[0].cells;
            const xCol = document.getElementById('x-col');
            const yCol = document.getElementById('y-col');
            // Set xCol if ai_x is provided
            {% if ai_x %}
            let aiX = "{{ ai_x|lower }}";
            for (let i = 0; i < headerCells.length; i++) {
                if (headerCells[i].innerText.trim().toLowerCase() === aiX) { xCol.selectedIndex = i; }
            }
            {% endif %}
            // Set yCol if ai_y is provided
            {% if ai_y %}
            let aiY = "{{ ai_y|lower }}";
            for (let i = 0; i < headerCells.length; i++) {
                if (headerCells[i].innerText.trim().toLowerCase() === aiY) { yCol.selectedIndex = i; }
            }
            {% endif %}
            // Show chart if ai_chart is provided
            {% if ai_chart %}
            let aiChart = "{{ ai_chart }}";
            if (["bar","pie","line"].includes(aiChart)) {
                setTimeout(function() { selectChartType(aiChart); }, 200);
            }
            {% endif %}
        }
    });
    </script>
    {% endif %}
    {% endif %}
</body>
</html> 